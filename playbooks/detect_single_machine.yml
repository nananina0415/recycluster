---
# Detect a single machine task (called by loop)
- name: Prompt user to connect machine
  ansible.builtin.pause:
    prompt: |

      ═══════════════════════════════════════════════════════════════════
      Machine {{ idx + 1 }}/{{ total_machines }}
      ═══════════════════════════════════════════════════════════════════
      Name: {{ machine.name }}
      Role: {{ machine.role }}
      Expected IP: {{ machine.ip }}

      Please:
      1. Power on the machine
      2. Wait for it to boot (LED should be solid/blinking)
      3. Press ENTER when ready to scan...

  register: user_confirmation

- name: Scan network for active hosts (ping scan)
  ansible.builtin.command:
    cmd: nmap -sn -oG - {{ network_config.subnet }}
  register: new_scan
  changed_when: false

- name: Parse active hosts from scan
  ansible.builtin.set_fact:
    current_hosts: "{{ new_scan.stdout_lines |
      select('match', '^Host: [0-9]') |
      map('regex_replace', '^Host: ([0-9.]+) .*$', '\\1') |
      list }}"

- name: Find newly appeared hosts
  ansible.builtin.set_fact:
    new_hosts: "{{ current_hosts | difference(initial_hosts) }}"

- name: Debug - Show scan results
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      Network Scan Results:
      ═══════════════════════════════════════════════════════════════════
      Total active hosts: {{ current_hosts | length }}
      Initial hosts: {{ initial_hosts | length }}
      New hosts detected: {{ new_hosts }}
  when: true  # Set to false to disable debugging

- name: Extract new host IP
  ansible.builtin.set_fact:
    new_host_ip: "{{ new_hosts[0] if new_hosts | length > 0 else '' }}"

- name: Display detected host
  ansible.builtin.debug:
    msg: |
      ✓ New host detected!
      IP: {{ new_host_ip }}
      Mapping to: {{ machine.name }} ({{ machine.role }})
  when: new_host_ip != ''

- name: Warn if no new host detected
  ansible.builtin.debug:
    msg: |
      ⚠ No new host appeared on the network.
      Please check:
      - Machine is powered on and booted
      - Network cable is connected
      - Machine is on the same network ({{ network_config.subnet }})
  when: new_host_ip == ''

- name: Update machine with detected IP
  ansible.builtin.set_fact:
    detected_machines: "{{ detected_machines + [machine | combine({'detected_ip': new_host_ip})] }}"
  when: new_host_ip != ''

- name: Add to initial hosts (prevent re-detection)
  ansible.builtin.set_fact:
    initial_hosts: "{{ initial_hosts + [new_host_ip] }}"
  when: new_host_ip != ''
