---
# Detect a single machine task (called by loop)
- name: Prompt user to connect machine
  ansible.builtin.pause:
    prompt: |

      ═══════════════════════════════════════════════════════════════════
      Machine {{ idx + 1 }}/{{ total_machines }}
      ═══════════════════════════════════════════════════════════════════
      Name: {{ machine.name }}
      Role: {{ machine.role }}
      Expected IP: {{ machine.ip }}

      Please:
      1. Power on the machine
      2. Wait for it to boot (LED should be solid/blinking)
      3. Press ENTER when ready to scan...

  register: user_confirmation

- name: Scan network with avahi-browse (mDNS discovery)
  ansible.builtin.command:
    cmd: timeout 5 avahi-browse -art
  register: avahi_scan
  changed_when: false
  failed_when: false

- name: Parse avahi results for ReCyClusteR-Node
  ansible.builtin.set_fact:
    avahi_hosts: "{{ avahi_scan.stdout_lines |
      select('search', hostname_filter + '.*IPv4') |
      map('regex_search', 'address \\[([0-9.]+)\\]', '\\1') |
      select('string') |
      map('first') |
      list }}"

- name: Filter out already detected hosts
  ansible.builtin.set_fact:
    new_avahi_hosts: "{{ avahi_hosts | difference(initial_hosts) }}"

- name: Extract new host IP
  ansible.builtin.set_fact:
    new_host_ip: "{{ new_avahi_hosts[0] if new_avahi_hosts | length > 0 else '' }}"
    new_host_name: "{{ hostname_filter }}-Node"

- name: Display detected host
  ansible.builtin.debug:
    msg: |
      ✓ Host detected!
      IP: {{ new_host_ip }}
      Hostname: {{ new_host_name }}
      Mapping to: {{ machine.name }}
  when: new_host_ip != ''

- name: Debug - Show avahi scan results
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      Avahi mDNS Scan Results:
      ═══════════════════════════════════════════════════════════════════
      All hosts found: {{ avahi_hosts }}
      Initial hosts: {{ initial_hosts }}
      New hosts: {{ new_avahi_hosts }}
      Selected IP: {{ new_host_ip }}
  when: true  # Set to false to disable debugging

- name: Warn if no host detected
  ansible.builtin.debug:
    msg: |
      ⚠ No new host with hostname '{{ hostname_filter }}' detected via mDNS.
      Please check:
      - Machine is powered on and booted
      - Network cable is connected
      - Machine is on the same network ({{ network_config.subnet }})
      - Avahi daemon is running on the target machine
  when: new_host_ip == ''

- name: Update machine with detected IP
  ansible.builtin.set_fact:
    detected_machines: "{{ detected_machines + [machine | combine({'detected_ip': new_host_ip})] }}"
  when: new_host_ip != ''

- name: Add to initial hosts (prevent re-detection)
  ansible.builtin.set_fact:
    initial_hosts: "{{ initial_hosts + [new_host_ip] }}"
  when: new_host_ip != ''
