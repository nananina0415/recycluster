---
# Detect a single machine task (called by loop)
- name: Prompt user to connect machine
  ansible.builtin.pause:
    prompt: |

      ═══════════════════════════════════════════════════════════════════
      Machine {{ idx + 1 }}/{{ total_machines }}
      ═══════════════════════════════════════════════════════════════════
      Name: {{ machine.name }}
      Role: {{ machine.role }}
      Expected IP: {{ machine.ip }}

      Please:
      1. Power on the machine
      2. Wait for it to boot (LED should be solid/blinking)
      3. Press ENTER when ready to scan...

  register: user_confirmation

- name: Scan network for new hosts
  ansible.builtin.command:
    cmd: nmap -sn -oG - {{ network_config.subnet }}
  register: new_scan
  changed_when: false

- name: Debug - Show full nmap output
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      NMAP RAW OUTPUT (all lines):
      ═══════════════════════════════════════════════════════════════════
      {% for line in new_scan.stdout_lines %}
      {{ loop.index }}: {{ line }}
      {% endfor %}
  when: true  # Set to false to disable debugging

- name: Debug - Show lines matching "Host:"
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      Lines starting with "Host:":
      ═══════════════════════════════════════════════════════════════════
      {% for line in new_scan.stdout_lines %}
      {% if line.startswith('Host:') %}
      {{ line }}
      {% endif %}
      {% endfor %}
  when: true  # Set to false to disable debugging

- name: Debug - Show hostname filter
  ansible.builtin.debug:
    msg: "Looking for hostname containing: '{{ hostname_filter }}'"
  when: true  # Set to false to disable debugging

- name: Parse new scan results
  ansible.builtin.set_fact:
    current_hosts: "{{ new_scan.stdout_lines |
      select('match', '^Host:.*\\(' + hostname_filter + '.*\\)') |
      map('regex_replace', '^Host: ([0-9.]+) \\(([^)]+)\\).*$', '\\1,\\2') |
      list }}"

- name: Debug - Show parsed results
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      PARSED RESULTS:
      ═══════════════════════════════════════════════════════════════════
      Found {{ current_hosts | length }} matching hosts
      {% for host in current_hosts %}
      {{ loop.index }}. {{ host }}
      {% endfor %}
  when: true  # Set to false to disable debugging

- name: Extract new host IP and hostname
  ansible.builtin.set_fact:
    new_host_ip: "{{ current_hosts[0].split(',')[0] if current_hosts | length > 0 else '' }}"
    new_host_name: "{{ current_hosts[0].split(',')[1] if current_hosts | length > 0 else '' }}"

- name: Display detected host
  ansible.builtin.debug:
    msg: |
      ✓ Host detected!
      IP: {{ new_host_ip }}
      Hostname: {{ new_host_name }}
      Mapping to: {{ machine.name }}
  when: new_host_ip != ''

- name: Warn if no host detected
  ansible.builtin.debug:
    msg: |
      ⚠ No new host with hostname '{{ hostname_filter }}' detected.
      Please check:
      - Machine is powered on
      - Network cable is connected
      - Machine hostname is set to {{ hostname_filter }}-Node
  when: new_host_ip == ''

- name: Update machine with detected IP
  ansible.builtin.set_fact:
    detected_machines: "{{ detected_machines + [machine | combine({'detected_ip': new_host_ip})] }}"
  when: new_host_ip != ''

- name: Add to initial hosts (prevent re-detection)
  ansible.builtin.set_fact:
    initial_hosts: "{{ initial_hosts + [new_host_ip] }}"
  when: new_host_ip != ''
