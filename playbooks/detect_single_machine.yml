---
# Detect a single machine task (called by loop)
- name: Prompt user to connect machine
  ansible.builtin.pause:
    prompt: |

      ═══════════════════════════════════════════════════════════════════
      Machine {{ idx + 1 }}/{{ total_machines }}
      ═══════════════════════════════════════════════════════════════════
      Name: {{ machine.name }}
      Role: {{ machine.role }}
      Expected IP: {{ machine.ip }}

      Please:
      1. Power on the machine
      2. Wait for it to boot (LED should be solid/blinking)
      3. Press ENTER when ready to scan...

  register: user_confirmation

- name: Scan network for active hosts (ARP + ping scan)
  ansible.builtin.shell: |
    network="{{ network_config.subnet | regex_replace('/.*$', '') }}"
    prefix=$(echo $network | cut -d. -f1-3)

    # Method 1: Check ARP cache first (instant)
    ip neigh show | awk '{print $1}' | grep "^$prefix\." || true

    # Method 2: Broadcast ping (fast)
    ping -b -c 2 -W 1 $prefix.255 >/dev/null 2>&1 || true

    # Method 3: Parallel ping scan
    i=1
    while [ $i -le 254 ]; do
      (ping -c 1 -W 1 $prefix.$i >/dev/null 2>&1) &
      i=$((i + 1))
    done
    wait

    # Collect all results from ARP cache
    ip neigh show | awk '$NF != "FAILED" {print $1}' | grep "^$prefix\." | sort -u
  register: new_scan
  changed_when: false

- name: Parse active hosts from scan
  ansible.builtin.set_fact:
    current_hosts: "{{ new_scan.stdout_lines | select('match', '^[0-9]') | list }}"

- name: Find newly appeared hosts
  ansible.builtin.set_fact:
    new_hosts: "{{ current_hosts | difference(initial_hosts) }}"

- name: Debug - Show scan results
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      Network Scan Results:
      ═══════════════════════════════════════════════════════════════════
      Total active hosts: {{ current_hosts | length }}
      Initial hosts: {{ initial_hosts | length }}
      New hosts detected: {{ new_hosts }}
  when: true  # Set to false to disable debugging

- name: Check hostname for each new IP via SSH
  ansible.builtin.command:
    cmd: ssh -o StrictHostKeyChecking=no -o ConnectTimeout=2 -o BatchMode=yes root@{{ item }} 'hostname'
  register: hostname_checks
  loop: "{{ new_hosts }}"
  failed_when: false
  changed_when: false
  when: new_hosts | length > 0

- name: Filter IPs with correct hostname
  ansible.builtin.set_fact:
    valid_hosts: "{{ hostname_checks.results |
      selectattr('rc', 'equalto', 0) |
      selectattr('stdout', 'search', 'ReCyClusteR-Node') |
      map(attribute='item') |
      list }}"
  when: new_hosts | length > 0

- name: Debug - Show hostname check results
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════════
      Hostname Check Results (via SSH):
      ═══════════════════════════════════════════════════════════════════
      {% for result in hostname_checks.results %}
      {{ result.item }}: {{ result.stdout | trim if result.rc == 0 else 'SSH connection failed' }}
      {% endfor %}

      Valid hosts (ReCyClusteR-Node): {{ valid_hosts | default([]) }}
  when: new_hosts | length > 0 and true  # Set to false to disable debugging

- name: Extract new host IP
  ansible.builtin.set_fact:
    new_host_ip: "{{ valid_hosts[0] if (new_hosts | length > 0 and valid_hosts | default([]) | length > 0) else '' }}"

- name: Display detected host
  ansible.builtin.debug:
    msg: |
      ✓ New host detected!
      IP: {{ new_host_ip }}
      Mapping to: {{ machine.name }} ({{ machine.role }})
  when: new_host_ip != ''

- name: Warn if no new host detected
  ansible.builtin.debug:
    msg: |
      ⚠ No new host appeared on the network.
      Please check:
      - Machine is powered on and booted
      - Network cable is connected
      - Machine is on the same network ({{ network_config.subnet }})
  when: new_host_ip == ''

- name: Update machine with detected IP
  ansible.builtin.set_fact:
    detected_machines: "{{ detected_machines + [machine | combine({'detected_ip': new_host_ip})] }}"
  when: new_host_ip != ''

- name: Add to initial hosts (prevent re-detection)
  ansible.builtin.set_fact:
    initial_hosts: "{{ initial_hosts + [new_host_ip] }}"
  when: new_host_ip != ''
