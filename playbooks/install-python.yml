---
# RCCR - Install Python on Target Nodes
# Uses Ansible raw module (no Python required on targets)

- name: Load cluster configuration
  hosts: localhost
  gather_facts: false
  vars:
    cluster_config_file: "{{ playbook_dir }}/../cluster_config.yml"
  tasks:
    - name: Read cluster config
      include_vars:
        file: "{{ cluster_config_file }}"
        name: cluster

    - name: Add target nodes to inventory
      add_host:
        name: "{{ item.hostname }}"
        ansible_host: "{{ item.ip }}"
        ansible_user: "{{ cluster.ssh.user }}"
        ansible_ssh_private_key_file: "{{ cluster.ssh.private_key }}"
        ansible_ssh_common_args: "{{ cluster.ssh.options }}"
        groups: dynamic_targets
      loop: "{{ cluster.nodes }}"
      when: item.role == "target"

- name: Install Python on target nodes
  hosts: dynamic_targets
  gather_facts: false
  tasks:
    - name: Check if Python is already installed
      raw: "python3 --version"
      register: python_check
      ignore_errors: true
      changed_when: false

    - name: Install Python3 (if not present)
      raw: "apk update && apk add python3"
      when: python_check.rc != 0

    - name: Verify Python installation
      raw: "python3 --version"
      register: python_version
      changed_when: false

    - name: Display Python version
      debug:
        msg: "{{ item.hostname }}: {{ python_version.stdout }}"
      delegate_to: localhost
