---
# RCCR - Cluster Setup Playbook
# Configures all nodes according to cluster_config.yml

- name: Load cluster configuration
  hosts: localhost
  gather_facts: false
  vars:
    cluster_config_file: "{{ playbook_dir }}/../cluster_config.yml"
  tasks:
    - name: Read cluster config
      include_vars:
        file: "{{ cluster_config_file }}"
        name: cluster

    - name: Add all nodes to inventory
      add_host:
        name: "{{ item.hostname }}"
        ansible_host: "{{ item.ip }}"
        ansible_user: "{{ cluster.ssh.user }}"
        ansible_ssh_private_key_file: "{{ cluster.ssh.private_key }}"
        ansible_ssh_common_args: "{{ cluster.ssh.options }}"
        node_role: "{{ item.role }}"
        groups:
          - dynamic_all
          - "dynamic_{{ item.role }}"
      loop: "{{ cluster.nodes }}"

- name: Configure all cluster nodes
  hosts: dynamic_all
  gather_facts: true
  become: false
  tasks:
    - name: Set hostname
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ ansible_default_ipv4.address }} {{ inventory_hostname }}"
        state: present

    - name: Configure timezone (UTC)
      community.general.timezone:
        name: UTC
      ignore_errors: true

    - name: Update APK cache
      apk:
        update_cache: true

    - name: Install base packages
      apk:
        name:
          - sudo
          - curl
          - wget
          - ca-certificates
        state: present

- name: Configure target nodes
  hosts: dynamic_target
  gather_facts: false
  tasks:
    - name: Ensure Python3 is installed
      apk:
        name: python3
        state: present

    - name: Display target node info
      debug:
        msg: "Target node {{ inventory_hostname }} configured successfully"

- name: Configure control nodes
  hosts: dynamic_control
  gather_facts: false
  tasks:
    - name: Install control node packages
      apk:
        name:
          - python3
          - py3-yaml
          - ansible
        state: present

    - name: Display control node info
      debug:
        msg: "Control node {{ inventory_hostname }} configured successfully"

- name: Summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display cluster summary
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════╗
          ║                    Cluster Setup Complete                         ║
          ╚═══════════════════════════════════════════════════════════════════╝

          Cluster: {{ cluster.cluster.name }}
          Total nodes: {{ cluster.nodes | length }}

          Next steps:
            1. Verify connectivity: ansible dynamic_all -m ping
            2. Check status: ansible dynamic_all -m shell -a "hostname && uptime"
