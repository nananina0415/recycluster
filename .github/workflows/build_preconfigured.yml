name: Build Pre-configured Alpine Images

on:
  push:
    branches: [main, new]
  workflow_dispatch:

env:
  ALPINE_VERSION: "3.23.2"
  ALPINE_MIRROR: "https://dl-cdn.alpinelinux.org/alpine"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1  # ÏàúÏ∞® ÎπåÎìúÎ°ú Î¶¨ÏÜåÏä§ Í≤ΩÏüÅ Î∞©ÏßÄ
      matrix:
        include:
          # Standard ÏïÑÌÇ§ÌÖçÏ≤ò
          - arch: x86_64
            type: std
            qemu_system: qemu-system-x86_64
            qemu_machine: pc
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-standard-3.23.2-x86_64.iso"
          - arch: x86
            type: std
            qemu_system: qemu-system-i386
            qemu_machine: pc
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86/alpine-standard-3.23.2-x86.iso"
          - arch: aarch64
            type: std
            qemu_system: qemu-system-aarch64
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/aarch64/alpine-standard-3.23.2-aarch64.iso"
          # Raspberry Pi ÏïÑÌÇ§ÌÖçÏ≤ò
          - arch: aarch64
            type: rpi
            qemu_system: qemu-system-aarch64
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/aarch64/alpine-rpi-3.23.2-aarch64.img.gz"
          - arch: armv7
            type: rpi
            qemu_system: qemu-system-arm
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/armv7/alpine-rpi-3.23.2-armv7.img.gz"
          - arch: armhf
            type: rpi
            qemu_system: qemu-system-arm
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/armhf/alpine-rpi-3.23.2-armhf.img.gz"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-system-arm qemu-system-aarch64 \
            qemu-utils gzip wget xorriso expect

      - name: Download Alpine image
        run: |
          wget -q --show-progress -O alpine_download "${{ matrix.download_url }}"

      - name: Prepare image
        run: |
          if [[ "${{ matrix.type }}" == "std" ]]; then
            # ISOÎäî Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
            mv alpine_download alpine.iso
          else
            # IMG ÏïïÏ∂ï Ìï¥Ï†ú
            gunzip -c alpine_download > alpine.img
            # qcow2Î°ú Î≥ÄÌôò (Ïì∞Í∏∞ Í∞ÄÎä•ÌïòÎèÑÎ°ù)
            qemu-img convert -f raw -O qcow2 alpine.img alpine.qcow2
            qemu-img resize alpine.qcow2 +1G
            rm alpine.img
          fi

      - name: Create answerfile
        run: |
          cat > answerfile << 'EOF'
          # Keyboard layout
          KEYMAPOPTS="us us"
          # Hostname
          HOSTNAMEOPTS="-n ReCyClusteR-Node"
          # Network
          INTERFACESOPTS="auto lo
          iface lo inet loopback

          auto eth0
          iface eth0 inet dhcp
          "
          # DNS
          DNSOPTS="8.8.8.8"
          # Timezone
          TIMEZONEOPTS="-z UTC"
          # Proxy
          PROXYOPTS="none"
          # APK Mirror
          APKREPOSOPTS="-1"
          # SSH
          SSHDOPTS="-c openssh"
          # NTP
          NTPOPTS="-c chrony"
          # Disk mode
          DISKOPTS="none"
          # LBU
          LBUOPTS="none"
          # APK Cache
          APKCACHEOPTS="none"
          EOF

      - name: Boot and configure Alpine
        timeout-minutes: 60
        run: |
          # ÏÑ§Ï†ï Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±
          cat > setup.sh << 'SCRIPT_EOF'
          #!/bin/sh
          set -e

          # SSH ÌÇ§ ÏÑ§Ï†ï
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh

          cat > /root/.ssh/authorized_keys << 'EOF'
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPzvIteUj6kIAAPE8VsYJG7Ax6Q28jOce1d3vfPh71AJ recycluster-init-key
          EOF

          cat > /root/.ssh/id_ed25519 << 'EOF'
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
          QyNTUxOQAAACD87yLXlI+pCAADxPFbGCRuwMekNvIznHtXd73z4e9QCQAAAJj/Y6S4/2Ok
          uAAAAAtzc2gtZWQyNTUxOQAAACD87yLXlI+pCAADxPFbGCRuwMekNvIznHtXd73z4e9QCQ
          AAAEDKrmrbB2FntPlNC7NQeB9eJPNyWsOLFxAQifT4Cd6ycPzvIteUj6kIAAPE8VsYJG7A
          x6Q28jOce1d3vfPh71AJAAAAFHJlY3ljbHVzdGVyLWluaXQta2V5AQ==
          -----END OPENSSH PRIVATE KEY-----
          EOF

          cat > /root/.ssh/id_ed25519.pub << 'EOF'
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPzvIteUj6kIAAPE8VsYJG7Ax6Q28jOce1d3vfPh71AJ recycluster-init-key
          EOF

          cat > /root/.ssh/config << 'EOF'
          Host *
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF

          chmod 600 /root/.ssh/authorized_keys
          chmod 600 /root/.ssh/id_ed25519
          chmod 644 /root/.ssh/id_ed25519.pub
          chmod 600 /root/.ssh/config

          # LBUÏóê Ï∂îÍ∞ÄÌïòÍ≥† Ï†ÄÏû•
          lbu add /root/.ssh
          lbu commit -d

          poweroff
          SCRIPT_EOF

          chmod +x setup.sh

          # QEMUÎ°ú Î∂ÄÌåÖ Î∞è ÏÑ§Ï†ï
          if [[ "${{ matrix.type }}" == "std" ]]; then
            # ISO Î∂ÄÌåÖ
            timeout 3600 expect << 'EXPECT_EOF' || true
            set timeout -1
            spawn ${{ matrix.qemu_system }} \
              -M ${{ matrix.qemu_machine }} \
              -m 2048 \
              -smp 2 \
              -boot d \
              -cdrom alpine.iso \
              -nographic

            expect "login:"
            send "root\r"

            expect "#"
            send "setup-alpine -f answerfile\r"

            expect "#"
            send "./setup.sh\r"

            expect eof
            EXPECT_EOF
          else
            # IMG Î∂ÄÌåÖ
            timeout 3600 ${{ matrix.qemu_system }} \
              -M ${{ matrix.qemu_machine }} \
              -m 2048 \
              -smp 2 \
              -drive file=alpine.qcow2,format=qcow2 \
              -nographic || true

            # qcow2Î•º rawÎ°ú Î≥ÄÌôò
            qemu-img convert -f qcow2 -O raw alpine.qcow2 alpine.img
            gzip -c alpine.img > rccr-${{ github.run_number }}-${{ matrix.type }}-${{ matrix.arch }}.img.gz
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.type }}-${{ matrix.arch }}
          path: |
            rccr-*.iso.gz
            rccr-*.img.gz
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/new'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: ReCyClusteR Alpine Images v${{ github.run_number }}
          body: |
            ## Pre-configured Alpine Linux Images for ReCyClusteR

            ### üîë SSH Configuration
            - Hostname: `ReCyClusteR-Node`
            - Authentication: SSH key-based (password-less)
            - All nodes share the same SSH key for initial cluster setup

            ‚ö†Ô∏è **WARNING**: These images contain a shared SSH key for initial setup only.
            Replace with unique keys using Ansible after deployment.

            ### üì¶ Available Images
            - Standard x86_64, x86, aarch64
            - Raspberry Pi aarch64, armv7, armhf

            ### üöÄ Usage
            1. Flash image to device
            2. Boot and connect to network (DHCP)
            3. SSH using the provided key
            4. Run Ansible playbooks for cluster configuration
          files: |
            **/rccr-*.iso.gz
            **/rccr-*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
