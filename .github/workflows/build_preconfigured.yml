name: Build Pre-configured Alpine Images

on:
  push:
    branches: [main, new]
  workflow_dispatch:

env:
  ALPINE_VERSION: "3.23.2"
  ALPINE_MIRROR: "https://dl-cdn.alpinelinux.org/alpine"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Standard ÏïÑÌÇ§ÌÖçÏ≤ò
          - arch: x86_64
            type: std
            qemu_system: qemu-system-x86_64
            qemu_machine: pc
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86_64/alpine-standard-3.23.2-x86_64.iso"
          - arch: x86
            type: std
            qemu_system: qemu-system-i386
            qemu_machine: pc
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/x86/alpine-standard-3.23.2-x86.iso"
          - arch: aarch64
            type: std
            qemu_system: qemu-system-aarch64
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/aarch64/alpine-standard-3.23.2-aarch64.iso"
          # Raspberry Pi ÏïÑÌÇ§ÌÖçÏ≤ò
          - arch: aarch64
            type: rpi
            qemu_system: qemu-system-aarch64
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/aarch64/alpine-rpi-3.23.2-aarch64.img.gz"
          - arch: armv7
            type: rpi
            qemu_system: qemu-system-arm
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/armv7/alpine-rpi-3.23.2-armv7.img.gz"
          - arch: armhf
            type: rpi
            qemu_system: qemu-system-arm
            qemu_machine: virt
            download_url: "https://dl-cdn.alpinelinux.org/alpine/v3.23/releases/armhf/alpine-rpi-3.23.2-armhf.img.gz"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y alpine-make-vm-image gzip wget e2fsprogs dosfstools

      - name: Setup Alpine repositories
        run: |
          # Alpine Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ ÏÑ§Ï†ï
          echo "https://dl-cdn.alpinelinux.org/alpine/v3.23/main" | sudo tee /tmp/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/v3.23/community" | sudo tee -a /tmp/repositories

      - name: Build image with alpine-make-vm-image
        run: |
          # alpine-make-vm-imageÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
          OUTPUT_FILE="rccr-${{ github.run_number }}-${{ matrix.type }}-${{ matrix.arch }}.img"

          # Ïù¥ÎØ∏ÏßÄ ÌòïÏãù Í≤∞Ï†ï
          if [[ "${{ matrix.type }}" == "std" ]]; then
            FORMAT="iso"
          else
            FORMAT="rpi"
          fi

          # Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
          sudo alpine-make-vm-image \
            --image-format $FORMAT \
            --image-size 2G \
            --repositories-file /tmp/repositories \
            --packages "openssh" \
            --script-chroot \
            $OUTPUT_FILE - <<'SETUP_SCRIPT'
          #!/bin/sh
          set -e

          # Ìò∏Ïä§Ìä∏ÎÑ§ÏûÑ ÏÑ§Ï†ï
          echo "ReCyClusteR-Node" > /etc/hostname

          # ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÑ§Ï†ï
          cat > /etc/network/interfaces <<EOF
          auto lo
          iface lo inet loopback

          auto eth0
          iface eth0 inet dhcp
              hostname ReCyClusteR-Node
          EOF

          # SSH ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh

          # SSH ÌÇ§ ÏÑ§Ï†ï
          cat > /root/.ssh/authorized_keys <<EOF
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPzvIteUj6kIAAPE8VsYJG7Ax6Q28jOce1d3vfPh71AJ recycluster-init-key
          EOF

          cat > /root/.ssh/id_ed25519 <<EOF
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
          QyNTUxOQAAACD87yLXlI+pCAADxPFbGCRuwMekNvIznHtXd73z4e9QCQAAAJj/Y6S4/2Ok
          uAAAAAtzc2gtZWQyNTUxOQAAACD87yLXlI+pCAADxPFbGCRuwMekNvIznHtXd73z4e9QCQ
          AAAEDKrmrbB2FntPlNC7NQeB9eJPNyWsOLFxAQifT4Cd6ycPzvIteUj6kIAAPE8VsYJG7A
          x6Q28jOce1d3vfPh71AJAAAAFHJlY3ljbHVzdGVyLWluaXQta2V5AQ==
          -----END OPENSSH PRIVATE KEY-----
          EOF

          cat > /root/.ssh/id_ed25519.pub <<EOF
          ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPzvIteUj6kIAAPE8VsYJG7Ax6Q28jOce1d3vfPh71AJ recycluster-init-key
          EOF

          cat > /root/.ssh/config <<EOF
          Host *
              StrictHostKeyChecking no
              UserKnownHostsFile=/dev/null
          EOF

          chmod 600 /root/.ssh/authorized_keys
          chmod 600 /root/.ssh/id_ed25519
          chmod 644 /root/.ssh/id_ed25519.pub
          chmod 600 /root/.ssh/config

          # SSH ÏÑúÎπÑÏä§ ÌôúÏÑ±Ìôî
          rc-update add sshd default

          # LBU ÏÑ§Ï†ï (diskless Î™®ÎìúÏö©)
          lbu add /root/.ssh
          lbu add /etc/hostname
          lbu add /etc/network/interfaces
          lbu commit -d
          SETUP_SCRIPT

          # Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï
          if [[ "${{ matrix.type }}" == "std" ]]; then
            gzip $OUTPUT_FILE
            mv ${OUTPUT_FILE}.gz rccr-${{ github.run_number }}-${{ matrix.type }}-${{ matrix.arch }}.iso.gz
          else
            gzip $OUTPUT_FILE
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.type }}-${{ matrix.arch }}
          path: |
            rccr-*.iso.gz
            rccr-*.img.gz
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/new'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: ReCyClusteR Alpine Images v${{ github.run_number }}
          body: |
            ## Pre-configured Alpine Linux Images for ReCyClusteR

            ### üîë SSH Configuration
            - Hostname: `ReCyClusteR-Node`
            - Authentication: SSH key-based (password-less)
            - All nodes share the same SSH key for initial cluster setup

            ‚ö†Ô∏è **WARNING**: These images contain a shared SSH key for initial setup only.
            Replace with unique keys using Ansible after deployment.

            ### üì¶ Available Images
            - Standard x86_64, x86, aarch64
            - Raspberry Pi aarch64, armv7, armhf

            ### üöÄ Usage
            1. Flash image to device
            2. Boot and connect to network (DHCP)
            3. SSH using the provided key
            4. Run Ansible playbooks for cluster configuration
          files: |
            **/rccr-*.iso.gz
            **/rccr-*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
