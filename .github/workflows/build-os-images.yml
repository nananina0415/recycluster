name: Build and Release OS Images

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.0.2)'
        required: false
        default: '0.0.2'

permissions:
  contents: write

jobs:
  build-os-images:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86, x86_64, aarch64, rpi-aarch64, armv7, armhf]
        type: [control, target]
        include:
          - arch: x86
            platform: linux/386
          - arch: x86_64
            platform: linux/amd64
          - arch: aarch64
            platform: linux/arm64
          - arch: rpi-aarch64
            platform: linux/arm64
          - arch: armv7
            platform: linux/arm/v7
          - arch: armhf
            platform: linux/arm/v6

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate SSH temporary keys
        run: |
          mkdir -p .rccr
          ssh-keygen -t rsa -b 4096 -f .rccr/ssh_temp_key -N "" -C "rccr-temporary-key"
          chmod 600 .rccr/ssh_temp_key
          chmod 644 .rccr/ssh_temp_key.pub
          echo "âœ“ SSH keys generated"

      - name: Display build info
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           Building RCCR OS Image                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Architecture: ${{ matrix.arch }}"
          echo "Type: ${{ matrix.type }}"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Platform: ${{ matrix.platform }}"
          echo ""

      - name: Build OS image
        run: |
          bash scripts/build-single-image.sh \
            ${{ matrix.arch }} \
            ${{ matrix.type }} \
            ${{ steps.version.outputs.VERSION }}

      - name: List built files
        run: |
          echo "Built files:"
          find build/${{ matrix.arch }}-${{ matrix.type }} -type f -ls

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rccr-${{ steps.version.outputs.VERSION }}-${{ matrix.arch }}-${{ matrix.type }}
          path: |
            build/${{ matrix.arch }}-${{ matrix.type }}/rccr-*.iso
            build/${{ matrix.arch }}-${{ matrix.type }}/rccr-*.img
            build/${{ matrix.arch }}-${{ matrix.type }}/SHA256SUMS
          if-no-files-found: error
          retention-days: 30

  create-release:
    needs: build-os-images
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: |
          echo "Artifacts structure:"
          ls -R artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.iso" -o -name "*.img" \) -exec cp {} release/ \;

          # Generate master checksum
          cd release
          sha256sum * > SHA256SUMS
          cd ..

          echo "Release files:"
          ls -lh release/

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md <<'EOF'
          # RCCR v${{ steps.version.outputs.VERSION }}

          ## ðŸŽ‰ Alpine Linux Cluster Setup - OS Image Release

          ì´ ë¦´ë¦¬ìŠ¤ëŠ” ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ë¶€íŒ… ì´ë¯¸ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

          ### ðŸ“¦ ì œê³µ ì´ë¯¸ì§€

          **Control Node** (í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ ë…¸ë“œ):
          - Python3, Ansible, nmap ì‚¬ì „ ì„¤ì¹˜
          - SSH ìž„ì‹œ í‚¤ í¬í•¨
          - í˜¸ìŠ¤íŠ¸ëª…: `ReCyClusteR-Control`

          **Target Node** (ì›Œì»¤ ë…¸ë“œ):
          - Python3, Docker ì‚¬ì „ ì„¤ì¹˜
          - SSH ì„œë²„ ìžë™ ì‹œìž‘
          - í˜¸ìŠ¤íŠ¸ëª…: `ReCyClusteR-Target`

          ### ðŸ—ï¸ ì§€ì› ì•„í‚¤í…ì²˜

          - `x86_64`: 64-bit x86 (í˜„ëŒ€ PC, ì„œë²„)
          - `aarch64`: 64-bit ARM (Raspberry Pi 3/4/5, ARM64 ì„œë²„)

          ### ðŸš€ ì‚¬ìš© ë°©ë²•

          1. **ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ**
             ```bash
             # Control ë…¸ë“œìš©
             wget https://github.com/nananina0415/recycluster/releases/download/v${{ steps.version.outputs.VERSION }}/rccr-${{ steps.version.outputs.VERSION }}-x86_64-control.iso

             # Target ë…¸ë“œìš©
             wget https://github.com/nananina0415/recycluster/releases/download/v${{ steps.version.outputs.VERSION }}/rccr-${{ steps.version.outputs.VERSION }}-x86_64-target.iso
             ```

          2. **ë¶€íŒ… ë¯¸ë””ì–´ ìƒì„±**
             ```bash
             # USB/SD ì¹´ë“œì— í”Œëž˜ì‹œ
             dd if=rccr-*.iso of=/dev/sdX bs=4M status=progress
             ```

          3. **ë¶€íŒ… ë° ì„¤ì •**
             ```bash
             # Control ë…¸ë“œ ë¶€íŒ… í›„
             cd /root/rccr
             vi cluster_config.yml  # ì„¤ì • íŽ¸ì§‘
             ansible-playbook setup.playbook
             ```

          ### ðŸ” ë³´ì•ˆ

          âš ï¸ **ì¤‘ìš”**: ì´ë¯¸ì§€ì— í¬í•¨ëœ SSH í‚¤ëŠ” ìž„ì‹œ í‚¤ìž…ë‹ˆë‹¤.
          - `ansible-playbook setup.playbook` ì‹¤í–‰ ì‹œ ìžë™ìœ¼ë¡œ ìƒˆ í‚¤ë¡œ êµì²´ë©ë‹ˆë‹¤.
          - ìž„ì‹œ í‚¤ëŠ” ëª¨ë“  ë…¸ë“œì—ì„œ ìžë™ ì‚­ì œë©ë‹ˆë‹¤.

          ### ðŸ“„ ë¬¸ì„œ

          - [README.md](https://github.com/nananina0415/recycluster/blob/main/README.md)
          - [IMAGE_BUILD_STRATEGY.md](https://github.com/nananina0415/recycluster/blob/main/IMAGE_BUILD_STRATEGY.md)
          - [DISTRIBUTION.md](https://github.com/nananina0415/recycluster/blob/main/DISTRIBUTION.md)

          ### ðŸ” ì²´í¬ì„¬ ê²€ì¦

          ```bash
          sha256sum -c SHA256SUMS
          ```

          ---

          **ì „ì²´ ë³€ê²½ì‚¬í•­**: [CHANGELOG](https://github.com/nananina0415/recycluster/compare/v0.0.1...v${{ steps.version.outputs.VERSION }})
          EOF

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: RCCR v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Released Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          cd release
          for file in *.iso *.img; do
            if [ -f "$file" ]; then
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "| $file | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL**: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
