#!/usr/bin/env python3
"""
RCCR (ReCyClusteR) CLI
APK 패키지로 설치 후 'rccr' 명령어로 실행되는 메인 진입점
"""

import sys
import os
from pathlib import Path


def is_admin():
    """관리자/root 권한 확인 (크로스 플랫폼)"""
    if sys.platform == 'win32':
        try:
            import ctypes
            return ctypes.windll.shell32.IsUserAnAdmin() != 0
        except Exception:
            return False
    else:
        return os.geteuid() == 0


def main():
    """메인 CLI 함수"""
    # 설치 경로 확인
    if os.path.exists('/usr/share/rccr'):
        # APK 패키지로 설치된 경우
        install_dir = Path('/usr/share/rccr')
        sys.path.insert(0, str(install_dir / 'lib'))
    else:
        # 개발 환경 (로컬)
        install_dir = Path(__file__).parent.parent
        sys.path.insert(0, str(install_dir / 'lib'))

    # rccr_setup 모듈 임포트
    try:
        from rccr_setup import RCCRSetup
    except ImportError as e:
        print(f"오류: RCCR 모듈을 로드할 수 없습니다: {e}")
        sys.exit(1)

    # 커맨드 파싱
    if len(sys.argv) < 2:
        print_usage()
        sys.exit(1)

    command = sys.argv[1]

    if command == 'init':
        run_init(install_dir)
    elif command == 'setup':
        run_setup(install_dir)
    elif command == 'version' or command == '--version' or command == '-v':
        print_version()
    elif command == 'help' or command == '--help' or command == '-h':
        print_help()
    else:
        print(f"오류: 알 수 없는 명령어 '{command}'")
        print_usage()
        sys.exit(1)


def run_init(install_dir):
    """프로젝트 초기화 - 템플릿 파일 생성"""
    import shutil

    current_dir = Path.cwd()
    config_path = current_dir / 'cluster_config.yml'

    # 이미 존재하는지 확인
    if config_path.exists():
        print("오류: cluster_config.yml 파일이 이미 존재합니다.")
        print(f"위치: {config_path}")
        overwrite = input("덮어쓰시겠습니까? (y/n): ").strip().lower()
        if overwrite != 'y':
            print("초기화가 취소되었습니다.")
            sys.exit(0)

    # 템플릿 복사
    template_path = install_dir / 'cluster_config.yml'
    if not template_path.exists():
        print("오류: 템플릿 파일을 찾을 수 없습니다.")
        sys.exit(1)

    shutil.copy(template_path, config_path)

    print("=================================================================")
    print("  RCCR 프로젝트 초기화 완료!")
    print("=================================================================")
    print()
    print(f"✓ {config_path} 생성됨")
    print()
    print("다음 단계:")
    print("  1. cluster_config.yml 파일을 편집하여 클러스터를 구성하세요")
    print("     vi cluster_config.yml")
    print()
    print("  2. 편집 완료 후 셋업을 실행하세요")
    print("     sudo rccr setup")
    print()


def run_setup(install_dir):
    """셋업 프로세스 실행"""
    # Root/Admin 권한 확인 (Docker 컨테이너 내에서는 스킵)
    if not os.path.exists('/.dockerenv') and not is_admin():
        if sys.platform == 'win32':
            print("오류: 이 명령은 관리자 권한이 필요합니다.")
            print("다시 시도: PowerShell을 관리자 권한으로 실행하세요")
        else:
            print("오류: 이 명령은 root 권한이 필요합니다.")
            print("다시 시도: sudo rccr setup 또는 Docker 사용")
        sys.exit(1)

    # 현재 디렉토리에서 cluster_config.yml 찾기
    config_path = Path.cwd() / 'cluster_config.yml'

    if not config_path.exists():
        print("오류: cluster_config.yml 파일을 찾을 수 없습니다.")
        print()
        print("먼저 프로젝트를 초기화하세요:")
        print("  rccr init")
        print()
        sys.exit(1)

    # 종속성 설치 확인 및 설치
    install_dependencies()

    # Setup 실행
    from rccr_setup import RCCRSetup
    setup = RCCRSetup(str(config_path))
    exit_code = setup.run()

    if exit_code == 0:
        # 성공 시 Ansible playbook 실행
        run_ansible_deployment(install_dir)

    sys.exit(exit_code)


def install_dependencies():
    """필수 종속성 설치"""
    import subprocess

    print("=================================================================")
    print("  종속성 확인 중...")
    print("=================================================================")

    # nmap 확인
    try:
        subprocess.run(['nmap', '--version'], capture_output=True, check=True)
        print("✓ nmap: 설치됨")
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("→ nmap 설치 중...")
        subprocess.run(['apk', 'add', 'nmap'], check=True)

    # ansible 확인
    try:
        subprocess.run(['ansible', '--version'], capture_output=True, check=True)
        print("✓ ansible: 설치됨")
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("→ ansible 설치 중...")
        subprocess.run(['pip3', 'install', 'ansible'], check=True)

    # pyyaml 확인
    try:
        import yaml
        print("✓ pyyaml: 설치됨")
    except ImportError:
        print("→ pyyaml 설치 중...")
        subprocess.run(['pip3', 'install', 'pyyaml'], check=True)

    print()


def run_ansible_deployment(install_dir):
    """Ansible playbook을 실행하여 클러스터 배포"""
    import subprocess

    print("\n=================================================================")
    print("  Ansible playbook 실행 중...")
    print("=================================================================")

    config_path = Path.cwd() / 'cluster_config.yml'
    playbook_path = install_dir / 'deploy_cluster.playbook'

    if not config_path.exists():
        print("경고: cluster_config.yml 파일을 찾을 수 없습니다.")
        return

    if not playbook_path.exists():
        print("경고: deploy_cluster.playbook 파일을 찾을 수 없습니다.")
        return

    try:
        result = subprocess.run(
            ['ansible-playbook', '-e', f'@{config_path}', str(playbook_path)],
            check=False
        )

        if result.returncode != 0:
            print("\n경고: Ansible playbook 실행 중 오류가 발생했습니다.")
    except Exception as e:
        print(f"\n오류: Ansible playbook 실행 실패 - {e}")


def print_version():
    """버전 정보 출력"""
    print("RCCR (ReCyClusteR) v0.0.1")


def print_usage():
    """간단한 사용법 출력"""
    print("사용법: rccr <command>")
    print()
    print("명령어:")
    print("  init       프로젝트 초기화 (템플릿 파일 생성)")
    print("  setup      클러스터 셋업 시작")
    print("  version    버전 정보 출력")
    print("  help       도움말 출력")
    print()
    print("예제:")
    print("  rccr init         # 템플릿 생성")
    print("  sudo rccr setup   # 셋업 실행")


def print_help():
    """상세 도움말 출력"""
    print("""
RCCR (ReCyClusteR) - 클러스터 자동 셋업 도구
=================================================================

사용법:
  rccr init       프로젝트 초기화 (템플릿 파일 생성)
  rccr setup      클러스터 셋업 프로세스 시작
  rccr version    버전 정보 출력
  rccr help       이 도움말 출력

셋업 프로세스:
  1. 프로젝트 초기화
     rccr init
     - cluster_config.yml 템플릿 생성

  2. 설정 파일 편집
     vi cluster_config.yml
     - 클러스터 노드 및 컨테이너 정의

  3. 클러스터 셋업 실행
     sudo rccr setup
     - 네트워크 스캔 시작
     - 대화형 안내에 따라 노드 연결
     - 감지된 노드에 Docker 설치
     - 컨테이너 자동 배포

예제:
  # 1. 작업 디렉토리 생성
  mkdir my-cluster
  cd my-cluster

  # 2. 프로젝트 초기화
  rccr init

  # 3. 설정 편집
  vi cluster_config.yml

  # 4. 셋업 실행
  sudo rccr setup

자세한 정보:
  https://github.com/nananina0415/recycluster
""")


if __name__ == '__main__':
    main()
